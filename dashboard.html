<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据驾驶舱 - 阳光招生平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #0f52ba;
            --primary-light: #e6f0ff;
            --secondary-color: #f8fafc;
            --text-color: #333;
            --border-color: #ddd;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --success-color: #10b981;
        }
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            color: var(--text-color);
            background-color: #fff;
        }
        .navbar {
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .navbar-brand {
            background-color: var(--primary-color);
            color: white !important;
            padding: 0.5rem 1rem;
            border-radius: 4px;
        }
        .nav-link {
            color: var(--text-color) !important;
        }
        .nav-link:hover {
            color: var(--primary-color) !important;
            background-color: var(--primary-light);
        }
        .section-title {
            color: var(--primary-color);
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-light);
        }
        .footer {
            background-color: #f8f9fa;
            color: var(--text-color);
            padding: 20px 0;
            margin-top: 40px;
            border-top: 1px solid var(--border-color);
        }
        .card {
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        .badge-warning {
            background-color: var(--warning-color);
            color: white;
        }
        .badge-danger {
            background-color: var(--danger-color);
            color: white;
        }
        .badge-success {
            background-color: var(--success-color);
            color: white;
        }
        .dashboard-tab {
            cursor: pointer;
            padding: 10px 20px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .dashboard-tab.active {
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: bold;
        }
        .dashboard-content {
            display: none;
        }
        .dashboard-content.active {
            display: block;
        }
        .stat-card {
            background-color: var(--primary-light);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-bottom: 20px;
        }
        .progress-ring {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: conic-gradient(var(--primary-color) 0% var(--progress, 0%), #e6f0ff var(--progress, 0%) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .progress-ring::before {
            content: '';
            position: absolute;
            width: 60px;
            height: 60px;
            background-color: white;
            border-radius: 50%;
        }
        .progress-text {
            position: relative;
            z-index: 1;
            text-align: center;
        }
        .warning-item {
            border-left: 4px solid var(--warning-color);
            padding-left: 15px;
            margin-bottom: 15px;
        }
        .danger-item {
            border-left: 4px solid var(--danger-color);
            padding-left: 15px;
            margin-bottom: 15px;
        }
        .avatar-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .avatar-item {
            text-align: center;
            width: 80px;
        }
        .avatar-img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 5px;
            border: 2px solid var(--primary-light);
        }
        .avatar-name {
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="index.html">阳光招生平台</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="loginDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            登录
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="loginDropdown">
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#loginModal">用户名密码登录</a></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#phoneLoginModal">手机号验证码登录</a></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#wechatLoginModal">微信扫码登录</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="langToggle">EN</a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="admission_management.html">项目招生管理</a></li>
                      <li class="nav-item"><a class="nav-link" href="#">项目学生管理</a></li>
                      <li class="nav-item"><a class="nav-link" href="study_abroad.html">留学申请</a></li>
                      <li class="nav-item"><a class="nav-link" href="student_evaluation.html">学生评价</a></li>
                      <li class="nav-item"><a class="nav-link" href="teacher_evaluation.html">教师评价</a></li>
                      <li class="nav-item"><a class="nav-link" href="college_evaluation.html">院校评价</a></li>
                      <li class="nav-item"><a class="nav-link active" href="dashboard.html">数据驾驶舱</a></li>
                      <li class="nav-item"><a class="nav-link" href="#">重点工作进度</a></li>
                      <li class="nav-item"><a class="nav-link" href="academic_management.html">教务管理</a></li>
                      <li class="nav-item"><a class="nav-link" href="#">迎新系统</a></li>
                      <li class="nav-item"><a class="nav-link" href="#">校友系统</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 页面标题 -->
    <div class="container py-6">
        <h1 class="display-5 mb-2">数据驾驶舱</h1>
        <p class="text-muted"></p>
    </div>

    <!-- 主要内容区 -->
    <div class="container py-4">
        <div class="row">
            <!-- 左侧功能菜单 -->
            <div class="col-md-3">
                <div class="bg-white border rounded-lg shadow-sm p-4 mb-6">
                    <h3 class="section-title h5 mb-4">功能菜单</h3>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="#" class="d-flex align-items-center text-decoration-none text-dark hover:text-primary dashboard-tab active" data-target="project-dashboard"><i class="fas fa-chart-line me-2"></i> 项目全域数据感知驾驶舱</a></li>
                        <li class="mb-2"><a href="#" class="d-flex align-items-center text-decoration-none text-dark hover:text-primary dashboard-tab" data-target="college-dashboard"><i class="fas fa-university me-2"></i> 项目院校驾驶舱</a></li>
                        <li class="mb-2"><a href="#" class="d-flex align-items-center text-decoration-none text-dark hover:text-primary dashboard-tab" data-target="management-dashboard"><i class="fas fa-tachometer-alt me-2"></i> 管理方驾驶舱</a></li>
                    </ul>
                </div>

                <!-- 院校筛选 -->
                <div class="bg-white border rounded-lg shadow-sm p-4 mb-6" id="college-filter" style="display: none;">
                    <h3 class="section-title h5 mb-4">院校筛选</h3>
                    <div class="mb-3">
                        <label for="college-type" class="form-label">院校类型</label>
                        <select class="form-select" id="college-type">
                            <option value="all">全部院校</option>
                            <option value="domestic">国内院校</option>
                            <option value="international">国外院校</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="college-name" class="form-label">院校名称</label>
                        <input type="text" class="form-control" id="college-name" placeholder="输入院校名称">
                    </div>
                    <button class="btn btn-primary w-100">筛选</button>
                </div>
            </div>

            <!-- 右侧主要内容 -->
            <div class="col-md-9">
                <!-- 项目全域数据感知驾驶舱 -->
                <div id="project-dashboard" class="dashboard-content active">
                    <!-- 关键指标卡片 -->
                    <div class="row mb-6 flex-wrap">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number">85%</div>
                                <div class="text-sm">招生进度</div>
                                <div class="text-xs text-warning mt-1">离目标还有15%</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number">920</div>
                                <div class="text-sm">实际招生人数</div>
                                <div class="text-xs text-success mt-1">目标: 1000人</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number">78%</div>
                                <div class="text-sm">管理费收取进度</div>
                                <div class="text-xs text-danger mt-1">预警: 未达标</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number">120</div>
                                <div class="text-sm">佣金未收人数</div>
                                <div class="text-xs text-warning mt-1">需尽快处理</div>
                            </div>
                        </div>
                    </div>

                    <!-- AI数据分析和智能报告工具栏 -->
                    <div class="card mb-4 bg-light">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-1"><i class="fas fa-brain text-primary"></i> AI智能分析工具</h5>
                                    <p class="text-muted mb-0">使用AI技术深度分析数据，生成智能报告和预测</p>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-primary" onclick="generateIntelligentReport()">
                                        <i class="fas fa-file-alt"></i> 生成智能报告
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="toggleMonitoringPanel()">
                                        <i class="fas fa-chart-line"></i> 实时监控
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 招生进度与预警 -->
                    <div class="card mb-6">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h2 class="h4 mb-0">招生计划及实际招生进度和预警</h2>
                            <button class="btn btn-sm btn-outline-light" onclick="exportDashboardData('admission-progress')" title="导出数据">
                                <i class="fas fa-download"></i> 导出
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="admissionProgressChart"></canvas>
                            </div>
                            <div class="mt-4">
                                <div class="warning-item">
                                    <h4 class="h6 text-warning">预警: 计算机科学专业</h4>
                                    <p class="text-sm">招生进度落后目标12%，请加强宣传。</p>
                                </div>
                                <div class="danger-item">
                                    <h4 class="h6 text-danger">危险: 机械工程专业</h4>
                                    <p class="text-sm">招生进度严重落后目标25%，需紧急调整招生策略。</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 生源指数 -->
                    <div class="row mb-6">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h2 class="h4 mb-0">生源指数 - 省份分布</h2>
                                    <button class="btn btn-sm btn-outline-light" onclick="exportDashboardData('student-source-province')" title="导出数据">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="studentSourceProvinceChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h2 class="h4 mb-0">生源指数 - 性别与民族</h2>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="studentSourceGenderEthnicChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 在校生指数 -->
                    <div class="row mb-6">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h2 class="h4 mb-0">在校生指数 - 违规违纪率</h2>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="disciplinaryRateChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h2 class="h4 mb-0">在校生指数 - 学籍异动统计</h2>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="studentStatusChangeChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 学生出路信息统计 -->
                    <div class="card mb-6">
                        <div class="card-header">
                            <h2 class="h4 mb-0">学生出路信息统计</h2>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-4 text-center">
                                    <div class="progress-ring mx-auto mb-3" style="--progress: 85%">
                                        <div class="progress-text">
                                            <div class="h3 font-bold">85%</div>
                                            <div class="text-sm">获证率</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-center">
                                    <div class="progress-ring mx-auto mb-3" style="--progress: 72%">
                                        <div class="progress-text">
                                            <div class="h3 font-bold">72%</div>
                                            <div class="text-sm">出国率</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-center">
                                    <div class="progress-ring mx-auto mb-3" style="--progress: 45%">
                                        <div class="progress-text">
                                            <div class="h3 font-bold">45%</div>
                                            <div class="text-sm">QS前100</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="studentOutcomeChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- 画像功能区 -->
                    <div class="row mb-6">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h2 class="h4 mb-0">学生画像</h2>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="studentPortraitChart"></canvas>
                                    </div>
                                    <div class="avatar-list mt-4">
                                        <div class="avatar-item">
                                            <img src="https://picsum.photos/id/1/100/100" alt="学生头像" class="avatar-img">
                                            <div class="avatar-name">张三</div>
                                        </div>
                                        <div class="avatar-item">
                                            <img src="https://picsum.photos/id/2/100/100" alt="学生头像" class="avatar-img">
                                            <div class="avatar-name">李四</div>
                                        </div>
                                        <div class="avatar-item">
                                            <img src="https://picsum.photos/id/3/100/100" alt="学生头像" class="avatar-img">
                                            <div class="avatar-name">王五</div>
                                        </div>
                                        <div class="avatar-item">
                                            <img src="https://picsum.photos/id/4/100/100" alt="学生头像" class="avatar-img">
                                            <div class="avatar-name">赵六</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h2 class="h4 mb-0">教师画像</h2>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="teacherPortraitChart"></canvas>
                                    </div>
                                    <div class="avatar-list mt-4">
                                        <div class="avatar-item">
                                            <img src="https://picsum.photos/id/10/100/100" alt="教师头像" class="avatar-img">
                                            <div class="avatar-name">王教授</div>
                                        </div>
                                        <div class="avatar-item">
                                            <img src="https://picsum.photos/id/11/100/100" alt="教师头像" class="avatar-img">
                                            <div class="avatar-name">李讲师</div>
                                        </div>
                                        <div class="avatar-item">
                                            <img src="https://picsum.photos/id/12/100/100" alt="教师头像" class="avatar-img">
                                            <div class="avatar-name">张副教授</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-6">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h2 class="h4 mb-0">院校画像</h2>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="collegePortraitChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h2 class="h4 mb-0">专业画像</h2>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="majorPortraitChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 项目院校驾驶舱 -->
                <div id="college-dashboard" class="dashboard-content">
                    <!-- 院校关键指标 -->
                    <div class="row mb-6 flex-wrap">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number">820</div>
                                <div class="text-sm">在校学生</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number">92%</div>
                                <div class="text-sm">就业率</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number">85%</div>
                                <div class="text-sm">满意度</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number">78%</div>
                                <div class="text-sm">毕业率</div>
                            </div>
                        </div>
                    </div>

                    <!-- 院校招生数据 -->
                    <div class="card mb-6">
                        <div class="card-header">
                            <h2 class="h4 mb-0">院校招生数据</h2>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="collegeAdmissionChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- 专业分布 -->
                    <div class="card mb-6">
                        <div class="card-header">
                            <h2 class="h4 mb-0">专业分布</h2>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="majorDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- 学生成绩分析 -->
                    <div class="card mb-6">
                        <div class="card-header">
                            <h2 class="h4 mb-0">学生成绩分析</h2>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="studentPerformanceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 管理方驾驶舱 -->
                <div id="management-dashboard" class="dashboard-content">
                    <!-- 关键指标卡片 -->
                    <div class="row mb-6 flex-wrap">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number">92%</div>
                                <div class="text-sm">项目完成率</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number">85%</div>
                                <div class="text-sm">预算执行率</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number">96%</div>
                                <div class="text-sm">满意度</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number">5</div>
                                <div class="text-sm">预警项</div>
                            </div>
                        </div>
                    </div>

                    <!-- 重点业务工作进度 -->
                    <div class="card mb-6">
                        <div class="card-header">
                            <h2 class="h4 mb-0">重点业务工作进度</h2>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <h4 class="h6 mb-2">招生计划制定</h4>
                                <div class="progress">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">100%</div>
                                </div>
                            </div>
                            <div class="mb-4">
                                <h4 class="h6 mb-2">招生简章发布</h4>
                                <div class="progress">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">100%</div>
                                </div>
                            </div>
                            <div class="mb-4">
                                <h4 class="h6 mb-2">报名系统开发</h4>
                                <div class="progress">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 95%" aria-valuenow="95" aria-valuemin="0" aria-valuemax="100">95%</div>
                                </div>
                            </div>
                            <div class="mb-4">
                                <h4 class="h6 mb-2">奖学金评定</h4>
                                <div class="progress">
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: 65%" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100">65%</div>
                                </div>
                            </div>
                            <div class="mb-4">
                                <h4 class="h6 mb-2">迎新准备工作</h4>
                                <div class="progress">
                                    <div class="progress-bar bg-danger" role="progressbar" style="width: 40%" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100">40%</div>
                                </div>
                                <p class="text-xs text-danger mt-1">预警: 进度落后，需加快推进</p>
                            </div>
                        </div>
                    </div>

                    <!-- 预算执行情况 -->
                    <div class="card mb-6">
                        <div class="card-header">
                            <h2 class="h4 mb-0">预算执行情况</h2>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="budgetExecutionChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- 预警信息 -->
                    <div class="card mb-6">
                        <div class="card-header">
                            <h2 class="h4 mb-0">预警信息</h2>
                        </div>
                        <div class="card-body">
                            <div class="danger-item">
                                <h4 class="h6 text-danger">财务预警</h4>
                                <p class="text-sm">管理费收取进度落后目标22%，请财务部门加强催收。</p>
                            </div>
                            <div class="warning-item">
                                <h4 class="h6 text-warning">招生预警</h4>
                                <p class="text-sm">机械工程专业招生进度落后目标15%，需调整招生策略。</p>
                            </div>
                            <div class="warning-item">
                                <h4 class="h6 text-warning">迎新准备预警</h4>
                                <p class="text-sm">迎新准备工作进度仅40%，离新生报到还有20天。</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="footer">
        <div class="container text-center">
            <p>© 2025 教育部留学服务中心 版权所有</p>
            <p>联系电话：010-62677800 | 邮箱：admin@cscse.edu.cn</p>
        </div>
    </footer>

    <!-- 登录模态框 -->
    <!-- 用户名密码登录模态框 -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">用户名密码登录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label for="username" class="form-label">用户名</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">密码</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="rememberMe">
                            <label class="form-check-label" for="rememberMe">记住我</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary">登录</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 手机号验证码登录模态框 -->
    <div class="modal fade" id="phoneLoginModal" tabindex="-1" aria-labelledby="phoneLoginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="phoneLoginModalLabel">手机号验证码登录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label for="phoneNumber" class="form-label">手机号</label>
                            <input type="tel" class="form-control" id="phoneNumber" required>
                        </div>
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-7">
                                    <label for="verifyCode" class="form-label">验证码</label>
                                    <input type="text" class="form-control" id="verifyCode" required>
                                </div>
                                <div class="col-5">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="button" class="btn btn-outline-primary form-control" id="sendCodeBtn">获取验证码</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary">登录</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 微信扫码登录模态框 -->
    <div class="modal fade" id="wechatLoginModal" tabindex="-1" aria-labelledby="wechatLoginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="wechatLoginModalLabel">微信扫码登录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="wechat-qrcode bg-white p-4 rounded" style="width: 200px; height: 200px; margin: 0 auto; display: flex; justify-content: center; align-items: center;">
                        <div style="color: #07C160; font-size: 1.2rem;">微信扫码区域</div>
                    </div>
                    <p class="mt-3">请使用微信扫码登录</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 验证码倒计时功能
        function initSendCodeBtn() {
            const sendCodeBtn = document.getElementById('sendCodeBtn');
            if (sendCodeBtn) {
                sendCodeBtn.addEventListener('click', function() {
                    let countdown = 60;
                    const originalText = this.textContent;
                    this.disabled = true;
                    this.textContent = `重新发送(${countdown}s)`;

                    // 模拟发送验证码
                    console.log('发送验证码到手机: ' + document.getElementById('phoneNumber').value);

                    const timer = setInterval(() => {
                        countdown--;
                        this.textContent = `重新发送(${countdown}s)`;

                        if (countdown <= 0) {
                            clearInterval(timer);
                            this.disabled = false;
                            this.textContent = originalText;
                        }
                    }, 1000);
                });
            }
        }

        // 用户名密码登录功能
        function initLoginModal() {
            const loginBtn = document.querySelector('#loginModal .btn-primary');
            if (loginBtn) {
                loginBtn.addEventListener('click', function() {
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;

                    if (!username || !password) {
                        alert('请输入用户名和密码');
                        return;
                    }

                    // 模拟登录验证
                    console.log('用户名密码登录: ' + username + ' / ' + password);

                    // 这里应该发送AJAX请求到服务器进行验证
                    // 模拟登录成功
                    alert('登录成功！欢迎 ' + username);
                    document.querySelector('#loginModal .btn-close').click();
                });
            }
        }

        // 手机号验证码登录功能
        function initPhoneLoginModal() {
            const phoneLoginBtn = document.querySelector('#phoneLoginModal .btn-primary');
            if (phoneLoginBtn) {
                phoneLoginBtn.addEventListener('click', function() {
                    const phoneNumber = document.getElementById('phoneNumber').value;
                    const verifyCode = document.getElementById('verifyCode').value;

                    if (!phoneNumber || !verifyCode) {
                        alert('请输入手机号和验证码');
                        return;
                    }

                    // 模拟登录验证
                    console.log('手机号验证码登录: ' + phoneNumber + ' / ' + verifyCode);

                    // 这里应该发送AJAX请求到服务器进行验证
                    // 模拟登录成功
                    alert('登录成功！欢迎 ' + phoneNumber);
                    document.querySelector('#phoneLoginModal .btn-close').click();
                });
            }
        }

        // 微信扫码登录模拟
        function initWechatLoginModal() {
            const wechatQrCode = document.querySelector('.wechat-qrcode');
            if (wechatQrCode) {
                // 模拟生成二维码
                wechatQrCode.innerHTML = '<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://example.com/login/wechat" alt="微信登录二维码" style="width: 150px; height: 150px;">';
            }
        }

        // 初始化图表
        window.addEventListener('DOMContentLoaded', function() {
            if(typeof Chart !== 'undefined') {
                initCharts();
            }
            initDashboardTabs();
            initLangToggle();
            initSendCodeBtn();
            initLoginModal();
            initPhoneLoginModal();
            initWechatLoginModal();
        });

        // 切换仪表盘标签
        function initDashboardTabs() {
            const tabs = document.querySelectorAll('.dashboard-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    // 移除所有激活状态
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.dashboard-content').forEach(c => c.classList.remove('active'));
                    // 添加当前激活状态
                    this.classList.add('active');
                    const target = this.getAttribute('data-target');
                    document.getElementById(target).classList.add('active');

                    // 显示/隐藏院校筛选
                    if(target === 'college-dashboard') {
                        document.getElementById('college-filter').style.display = 'block';
                    } else {
                        document.getElementById('college-filter').style.display = 'none';
                    }
                });
            });
        }

        // 中英文切换
        function initLangToggle() {
            document.getElementById('langToggle').addEventListener('click', function() {
                const currentLang = this.textContent;
                if (currentLang === 'EN') {
                    this.textContent = '中文';
                    // 这里可以添加英文切换逻辑
                } else {
                    this.textContent = 'EN';
                    // 这里可以添加中文切换逻辑
                }
            });
        }

        // 全局变量存储图表实例
        let chartInstances = {};

        // 销毁已存在的图表实例
        function destroyExistingCharts() {
            for (let chartKey in chartInstances) {
                if (chartInstances[chartKey] && typeof chartInstances[chartKey].destroy === 'function') {
                    chartInstances[chartKey].destroy();
                    delete chartInstances[chartKey];
                }
            }
        }

        // 初始化图表
        function initCharts() {
            // 销毁已存在的图表实例
            destroyExistingCharts();

            // 招生进度图表
            const admissionProgressCtx = document.getElementById('admissionProgressChart').getContext('2d');
            chartInstances.admissionProgressChart = new Chart(admissionProgressCtx, {
                type: 'bar',
                data: {
                    labels: ['计算机科学', '电子信息', '机械工程', '医学', '经济', '管理'],
                    datasets: [{
                        label: '目标招生',
                        data: [200, 180, 150, 220, 180, 170],
                        backgroundColor: '#e6f0ff',
                        borderColor: '#0f52ba',
                        borderWidth: 1
                    }, {
                        label: '实际招生',
                        data: [176, 165, 112, 205, 168, 154],
                        backgroundColor: '#0f52ba',
                        borderColor: '#0f52ba',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: '各专业招生进度对比'
                        }
                    }
                }
            });

            // 生源指数 - 省份分布
            const studentSourceProvinceCtx = document.getElementById('studentSourceProvinceChart').getContext('2d');
            chartInstances.studentSourceProvinceChart = new Chart(studentSourceProvinceCtx, {
                type: 'pie',
                data: {
                    labels: ['北京', '上海', '广东', '江苏', '浙江', '其他'],
                    datasets: [{
                        label: '学生数量',
                        data: [220, 180, 150, 120, 100, 150],
                        backgroundColor: [
                            '#0f52ba',
                            '#1e88e5',
                            '#2196f3',
                            '#64b5f6',
                            '#90caf9',
                            '#bbdefb'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: '学生来源省份分布'
                        }
                    }
                }
            });

            // 生源指数 - 性别与民族
            const studentSourceGenderEthnicCtx = document.getElementById('studentSourceGenderEthnicChart').getContext('2d');
            chartInstances.studentSourceGenderEthnicChart = new Chart(studentSourceGenderEthnicCtx, {
                type: 'doughnut',
                data: {
                    labels: ['汉族', '少数民族'],
                    datasets: [{
                        label: '男生',
                        data: [450, 80],
                        backgroundColor: [
                            '#0f52ba',
                            '#1e88e5'
                        ],
                        borderWidth: 1
                    }, {
                        label: '女生',
                        data: [320, 70],
                        backgroundColor: [
                            '#90caf9',
                            '#bbdefb'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: '学生性别与民族分布'
                        }
                    }
                }
            });

            // 违规违纪率图表
            const disciplinaryRateCtx = document.getElementById('disciplinaryRateChart').getContext('2d');
            chartInstances.disciplinaryRateChart = new Chart(disciplinaryRateCtx, {
                type: 'line',
                data: {
                    labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
                    datasets: [{
                        label: '违规违纪率',
                        data: [1.2, 0.8, 1.5, 0.9, 1.1, 0.7],
                        backgroundColor: 'rgba(239, 68, 68, 0.2)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '近6个月违规违纪率变化'
                        }
                    }
                }
            });

            // 学籍异动统计图表
            const studentStatusChangeCtx = document.getElementById('studentStatusChangeChart').getContext('2d');
            chartInstances.studentStatusChangeChart = new Chart(studentStatusChangeCtx, {
                type: 'bar',
                data: {
                    labels: ['退学', '转学', '休学', '复学', '其他'],
                    datasets: [{
                        label: '人数',
                        data: [15, 8, 12, 5, 3],
                        backgroundColor: [
                            '#ef4444',
                            '#f59e0b',
                            '#10b981',
                            '#3b82f6',
                            '#8b5cf6'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '学籍异动统计'
                        }
                    }
                }
            });

            // 学生出路信息统计图表
            const studentOutcomeCtx = document.getElementById('studentOutcomeChart').getContext('2d');
            chartInstances.studentOutcomeChart = new Chart(studentOutcomeCtx, {
                type: 'radar',
                data: {
                    labels: ['获证率', '出国率', 'QS前100', '就业率', '深造率'],
                    datasets: [{
                        label: '2024届',
                        data: [85, 72, 45, 92, 68],
                        backgroundColor: 'rgba(15, 82, 186, 0.2)',
                        borderColor: 'rgba(15, 82, 186, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(15, 82, 186, 1)'
                    }, {
                        label: '2023届',
                        data: [80, 65, 38, 88, 62],
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(16, 185, 129, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                display: true
                            },
                            suggestedMin: 0,
                            suggestedMax: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '学生出路对比'
                        }
                    }
                }
            });

            // 学生画像图表
            const studentPortraitCtx = document.getElementById('studentPortraitChart').getContext('2d');
            chartInstances.studentPortraitChart = new Chart(studentPortraitCtx, {
                type: 'polarArea',
                data: {
                    labels: ['计算机科学', '电子信息', '机械工程', '医学', '经济', '管理'],
                    datasets: [{
                        data: [28, 22, 15, 18, 12, 5],
                        backgroundColor: [
                            '#0f52ba',
                            '#1e88e5',
                            '#2196f3',
                            '#64b5f6',
                            '#90caf9',
                            '#bbdefb'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: '学生专业分布'
                        }
                    }
                }
            });

            // 教师画像图表
            const teacherPortraitCtx = document.getElementById('teacherPortraitChart').getContext('2d');
            chartInstances.teacherPortraitChart = new Chart(teacherPortraitCtx, {
                type: 'bar',
                data: {
                    labels: ['教授', '副教授', '讲师', '助教'],
                    datasets: [{
                        label: '人数',
                        data: [12, 28, 45, 15],
                        backgroundColor: [
                            '#0f52ba',
                            '#1e88e5',
                            '#2196f3',
                            '#64b5f6'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '教师职称分布'
                        }
                    }
                }
            });

            // 院校画像图表
            const collegePortraitCtx = document.getElementById('collegePortraitChart').getContext('2d');
            chartInstances.collegePortraitChart = new Chart(collegePortraitCtx, {
                type: 'bar',
                data: {
                    labels: ['综合类', '理工类', '文史类', '医学类', '财经类'],
                    datasets: [{
                        label: '院校数量',
                        data: [8, 12, 5, 3, 4],
                        backgroundColor: [
                            '#0f52ba',
                            '#1e88e5',
                            '#2196f3',
                            '#64b5f6',
                            '#90caf9'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '合作院校类型分布'
                        }
                    }
                }
            });

            // 专业画像图表
            const majorPortraitCtx = document.getElementById('majorPortraitChart').getContext('2d');
            chartInstances.majorPortraitChart = new Chart(majorPortraitCtx, {
                type: 'line',
                data: {
                    labels: ['计算机科学', '电子信息', '机械工程', '医学', '经济', '管理'],
                    datasets: [{
                        label: '热度指数',
                        data: [95, 88, 72, 85, 90, 78],
                        backgroundColor: 'rgba(15, 82, 186, 0.2)',
                        borderColor: 'rgba(15, 82, 186, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '专业热度指数'
                        }
                    }
                }
            });

            // 院校招生数据图表
            const collegeAdmissionCtx = document.getElementById('collegeAdmissionChart').getContext('2d');
            chartInstances.collegeAdmissionChart = new Chart(collegeAdmissionCtx, {
                type: 'bar',
                data: {
                    labels: ['2020', '2021', '2022', '2023', '2024', '2025'],
                    datasets: [{
                        label: '招生人数',
                        data: [650, 720, 780, 820, 880, 920],
                        backgroundColor: '#0f52ba',
                        borderColor: '#0f52ba',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '历年招生人数'
                        }
                    }
                }
            });

            // 专业分布图表
            const majorDistributionCtx = document.getElementById('majorDistributionChart').getContext('2d');
            chartInstances.majorDistributionChart = new Chart(majorDistributionCtx, {
                type: 'pie',
                data: {
                    labels: ['计算机科学', '电子信息', '机械工程', '医学', '经济', '管理'],
                    datasets: [{
                        label: '学生数量',
                        data: [250, 220, 180, 150, 120, 100],
                        backgroundColor: [
                            '#0f52ba',
                            '#1e88e5',
                            '#2196f3',
                            '#64b5f6',
                            '#90caf9',
                            '#bbdefb'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: '专业分布'
                        }
                    }
                }
            });

            // 学生成绩分析图表
            const studentPerformanceCtx = document.getElementById('studentPerformanceChart').getContext('2d');
            chartInstances.studentPerformanceChart = new Chart(studentPerformanceCtx, {
                type: 'line',
                data: {
                    labels: ['大一上', '大一下', '大二上', '大二下', '大三上', '大三下'],
                    datasets: [{
                        label: '平均分',
                        data: [78, 82, 85, 83, 86, 88],
                        backgroundColor: 'rgba(15, 82, 186, 0.2)',
                        borderColor: 'rgba(15, 82, 186, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 50,
                            max: 100
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '学生平均分变化趋势'
                        }
                    }
                }
            });

            // 预算执行情况图表
            const budgetExecutionCtx = document.getElementById('budgetExecutionChart').getContext('2d');
            chartInstances.budgetExecutionChart = new Chart(budgetExecutionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['已执行', '未执行'],
                    datasets: [{
                        data: [85, 15],
                        backgroundColor: [
                            '#10b981',
                            '#e5e7eb'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: '预算执行情况'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.raw + '%';
                                }
                            }
                        }
                    },
                    cutout: '70%'
                }
            });
        }

        // AI数据分析引擎
        class AIDataAnalysisEngine {
            constructor() {
                this.apiKey = 'sk-3cdcf9f01e5141d09060b4b76045edda';
                this.apiUrl = 'https://api.deepseek.com/v1/chat/completions';
                this.analysisResults = JSON.parse(localStorage.getItem('aiAnalysisResults') || '{}');
                this.init();
            }

            init() {
                this.addAnalysisButtons();
                this.loadPreviousAnalysis();
            }

            addAnalysisButtons() {
                // 为每个图表添加AI分析按钮
                const chartContainers = document.querySelectorAll('.chart-container');
                chartContainers.forEach((container, index) => {
                    const button = document.createElement('button');
                    button.className = 'btn btn-sm btn-primary mt-2';
                    button.innerHTML = '<i class="fas fa-brain"></i> AI分析';
                    button.onclick = () => this.analyzeChart(container, index);
                    container.appendChild(button);
                });
            }

            async analyzeChart(container, chartIndex) {
                const button = container.querySelector('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 分析中...';
                button.disabled = true;

                try {
                    // 获取图表数据
                    const chartData = this.extractChartData(chartIndex);
                    
                    // 调用AI分析
                    const analysis = await this.callAIAnalysis(chartData);
                    
                    // 显示分析结果
                    this.displayAnalysis(container, analysis, chartIndex);
                    
                    // 保存分析结果
                    this.analysisResults[chartIndex] = {
                        analysis: analysis,
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem('aiAnalysisResults', JSON.stringify(this.analysisResults));
                    
                } catch (error) {
                    console.error('AI分析失败:', error);
                    this.displayAnalysis(container, '分析失败，请稍后重试。', chartIndex);
                } finally {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            }

            extractChartData(chartIndex) {
                // 根据图表索引提取相应的数据
                const chartDataMap = {
                    0: { type: '招生进度', data: '计算机科学: 88%, 电子信息: 92%, 机械工程: 75%' },
                    1: { type: '生源分布', data: '北京: 25%, 上海: 20%, 广东: 18%, 江苏: 15%' },
                    2: { type: '学生成绩', data: '平均分: 85分, 及格率: 95%, 优秀率: 35%' },
                    3: { type: '就业情况', data: '就业率: 92%, 出国率: 72%, QS前100: 45%' }
                };
                return chartDataMap[chartIndex] || { type: '数据图表', data: '暂无具体数据' };
            }

            async callAIAnalysis(chartData) {
                const prompt = `请分析以下${chartData.type}数据：${chartData.data}。
                请提供：
                1. 数据趋势分析
                2. 关键发现和洞察
                3. 潜在问题和风险
                4. 改进建议
                请用简洁专业的语言回答，控制在200字以内。`;

                const response = await fetch(this.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: '你是一个专业的教育数据分析师，擅长分析招生、教学和管理数据，提供有价值的洞察和建议。'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 500
                    })
                });

                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            }

            displayAnalysis(container, analysis, chartIndex) {
                // 移除之前的分析结果
                const existingAnalysis = container.querySelector('.ai-analysis-result');
                if (existingAnalysis) {
                    existingAnalysis.remove();
                }

                // 创建分析结果显示区域
                const analysisDiv = document.createElement('div');
                analysisDiv.className = 'ai-analysis-result mt-3 p-3 bg-light rounded';
                analysisDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0"><i class="fas fa-brain text-primary"></i> AI分析结果</h6>
                        <button class="btn btn-sm btn-outline-secondary" onclick="this.parentElement.parentElement.style.display='none'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="analysis-content" style="font-size: 0.9em; line-height: 1.5;">
                        ${analysis.replace(/\n/g, '<br>')}
                    </div>
                    <div class="text-muted mt-2" style="font-size: 0.8em;">
                        分析时间: ${new Date().toLocaleString()}
                    </div>
                `;
                container.appendChild(analysisDiv);
            }

            loadPreviousAnalysis() {
                // 加载之前的分析结果
                Object.keys(this.analysisResults).forEach(chartIndex => {
                    const container = document.querySelectorAll('.chart-container')[chartIndex];
                    if (container) {
                        const result = this.analysisResults[chartIndex];
                        this.displayAnalysis(container, result.analysis, chartIndex);
                    }
                });
            }

            // 生成智能报告
            async generateIntelligentReport() {
                const reportData = this.collectDashboardData();
                const prompt = `基于以下数据生成智能分析报告：
                ${JSON.stringify(reportData)}
                
                请生成一份包含以下内容的报告：
                1. 总体概况
                2. 关键指标分析
                3. 趋势预测
                4. 风险预警
                5. 改进建议
                
                报告应专业、简洁，适合管理层阅读。`;

                try {
                    const analysis = await this.callAIAnalysis({ type: '综合报告', data: JSON.stringify(reportData) });
                    this.displayIntelligentReport(analysis);
                } catch (error) {
                    console.error('智能报告生成失败:', error);
                }
            }

            collectDashboardData() {
                return {
                    招生数据: { 总计划: 1000, 已完成: 856, 完成率: '85.6%' },
                    生源分布: { 重点省份: '北京、上海、广东', 覆盖省份: 28 },
                    学生表现: { 平均分: 85, 及格率: '95%', 优秀率: '35%' },
                    就业情况: { 就业率: '92%', 出国率: '72%', 名校率: '45%' }
                };
            }

            displayIntelligentReport(report) {
                // 创建报告模态框
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-chart-bar"></i> AI智能分析报告</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="report-content" style="line-height: 1.6;">
                                    ${report.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" onclick="window.print()">打印报告</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
                
                // 模态框关闭后移除元素
                modal.addEventListener('hidden.bs.modal', () => {
                    document.body.removeChild(modal);
                });
            }
        }

        // 实时数据监控系统
        class RealTimeMonitoring {
            constructor() {
                this.monitoringData = {};
                this.alertThresholds = {
                    招生进度: 80, // 低于80%预警
                    系统负载: 90, // 高于90%预警
                    用户活跃度: 70 // 低于70%预警
                };
                this.init();
            }

            init() {
                this.startMonitoring();
                this.createMonitoringPanel();
            }

            startMonitoring() {
                // 模拟实时数据更新
                setInterval(() => {
                    this.updateMonitoringData();
                    this.checkAlerts();
                    this.updateMonitoringUI();
                }, 30000); // 每30秒更新一次
            }

            updateMonitoringData() {
                this.monitoringData = {
                    招生进度: Math.floor(Math.random() * 20) + 80, // 80-100
                    系统负载: Math.floor(Math.random() * 30) + 70, // 70-100
                    用户活跃度: Math.floor(Math.random() * 40) + 60, // 60-100
                    在线用户: Math.floor(Math.random() * 50) + 100, // 100-150
                    最后更新: new Date().toLocaleTimeString()
                };
            }

            checkAlerts() {
                Object.keys(this.alertThresholds).forEach(key => {
                    const value = this.monitoringData[key];
                    const threshold = this.alertThresholds[key];
                    
                    if ((key === '系统负载' && value > threshold) || 
                        (key !== '系统负载' && value < threshold)) {
                        this.triggerAlert(key, value, threshold);
                    }
                });
            }

            triggerAlert(metric, value, threshold) {
                // 创建警报通知
                const alert = document.createElement('div');
                alert.className = 'alert alert-warning alert-dismissible fade show position-fixed';
                alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
                alert.innerHTML = `
                    <strong>监控警报!</strong> ${metric}: ${value}% 
                    ${value > threshold ? '超过' : '低于'}阈值 ${threshold}%
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(alert);
                
                // 5秒后自动移除
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 5000);
            }

            createMonitoringPanel() {
                // 在页面右下角创建监控面板
                const panel = document.createElement('div');
                panel.id = 'realTimeMonitoringPanel';
                panel.className = 'position-fixed bg-white border rounded shadow-sm p-3';
                panel.style.cssText = 'bottom: 20px; right: 20px; z-index: 1000; min-width: 250px; display: none;';
                panel.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0"><i class="fas fa-monitor-heart-rate"></i> 实时监控</h6>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleMonitoringPanel()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="monitoringContent">
                        <!-- 监控数据将动态加载 -->
                    </div>
                `;
                document.body.appendChild(panel);
                
                // 添加切换按钮
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'btn btn-primary position-fixed';
                toggleBtn.style.cssText = 'bottom: 20px; right: 20px; z-index: 999;';
                toggleBtn.innerHTML = '<i class="fas fa-chart-line"></i>';
                toggleBtn.onclick = () => this.toggleMonitoringPanel();
                document.body.appendChild(toggleBtn);
            }

            toggleMonitoringPanel() {
                const panel = document.getElementById('realTimeMonitoringPanel');
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }

            updateMonitoringUI() {
                const content = document.getElementById('monitoringContent');
                if (!content) return;
                
                content.innerHTML = `
                    <div class="monitoring-item mb-2">
                        <div class="d-flex justify-content-between">
                            <span>招生进度</span>
                            <span class="badge ${this.monitoringData.招生进度 >= 80 ? 'bg-success' : 'bg-warning'}">${this.monitoringData.招生进度}%</span>
                        </div>
                    </div>
                    <div class="monitoring-item mb-2">
                        <div class="d-flex justify-content-between">
                            <span>系统负载</span>
                            <span class="badge ${this.monitoringData.系统负载 <= 90 ? 'bg-success' : 'bg-danger'}">${this.monitoringData.系统负载}%</span>
                        </div>
                    </div>
                    <div class="monitoring-item mb-2">
                        <div class="d-flex justify-content-between">
                            <span>用户活跃度</span>
                            <span class="badge ${this.monitoringData.用户活跃度 >= 70 ? 'bg-success' : 'bg-warning'}">${this.monitoringData.用户活跃度}%</span>
                        </div>
                    </div>
                    <div class="monitoring-item mb-2">
                        <div class="d-flex justify-content-between">
                            <span>在线用户</span>
                            <span class="badge bg-info">${this.monitoringData.在线用户}</span>
                        </div>
                    </div>
                    <div class="text-muted text-center mt-2" style="font-size: 0.8em;">
                        更新时间: ${this.monitoringData.最后更新}
                    </div>
                `;
            }
        }

        // 预测分析功能
        class PredictiveAnalysis {
            constructor() {
                this.historicalData = this.loadHistoricalData();
                this.predictions = {};
                this.init();
            }

            init() {
                this.addPredictionButtons();
                this.generatePredictions();
            }

            loadHistoricalData() {
                // 模拟历史数据
                return {
                    招生数据: [650, 720, 780, 820, 880, 920],
                    就业率: [88, 90, 91, 89, 92, 94],
                    满意度: [85, 87, 89, 88, 90, 92]
                };
            }

            addPredictionButtons() {
                // 在数据驾驶舱添加预测分析按钮
                const dashboardTabs = document.querySelector('.dashboard-tabs');
                if (dashboardTabs) {
                    const predictBtn = document.createElement('button');
                    predictBtn.className = 'btn btn-outline-primary ms-2';
                    predictBtn.innerHTML = '<i class="fas fa-crystal-ball"></i> 预测分析';
                    predictBtn.onclick = () => this.showPredictionModal();
                    dashboardTabs.appendChild(predictBtn);
                }
            }

            generatePredictions() {
                // 简单的线性预测算法
                Object.keys(this.historicalData).forEach(key => {
                    const data = this.historicalData[key];
                    const trend = this.calculateTrend(data);
                    const nextValue = data[data.length - 1] + trend;
                    
                    this.predictions[key] = {
                        nextPeriod: Math.round(nextValue),
                        trend: trend > 0 ? '上升' : trend < 0 ? '下降' : '稳定',
                        confidence: this.calculateConfidence(data)
                    };
                });
            }

            calculateTrend(data) {
                if (data.length < 2) return 0;
                
                const n = data.length;
                const sumX = (n * (n - 1)) / 2;
                const sumY = data.reduce((a, b) => a + b, 0);
                const sumXY = data.reduce((sum, y, x) => sum + x * y, 0);
                const sumX2 = data.reduce((sum, _, x) => sum + x * x, 0);
                
                return (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            }

            calculateConfidence(data) {
                // 基于数据稳定性计算置信度
                const variance = this.calculateVariance(data);
                const maxVariance = Math.max(...data) - Math.min(...data);
                return Math.max(60, 100 - (variance / maxVariance) * 40);
            }

            calculateVariance(data) {
                const mean = data.reduce((a, b) => a + b, 0) / data.length;
                return data.reduce((sum, x) => sum + Math.pow(x - mean, 2), 0) / data.length;
            }

            showPredictionModal() {
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-crystal-ball"></i> 预测分析报告</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${this.generatePredictionReport()}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
                
                modal.addEventListener('hidden.bs.modal', () => {
                    document.body.removeChild(modal);
                });
            }

            generatePredictionReport() {
                let report = '<div class="row">';
                
                Object.keys(this.predictions).forEach(key => {
                    const pred = this.predictions[key];
                    report += `
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <h6 class="card-title">${key}</h6>
                                    <div class="h4 text-primary">${pred.nextPeriod}</div>
                                    <div class="text-muted">预测值</div>
                                    <div class="mt-2">
                                        <span class="badge ${pred.trend === '上升' ? 'bg-success' : pred.trend === '下降' ? 'bg-danger' : 'bg-secondary'}">${pred.trend}</span>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">置信度: ${Math.round(pred.confidence)}%</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                report += '</div>';
                return report;
            }
        }

        // 初始化高级功能
        document.addEventListener('DOMContentLoaded', function() {
            // 图表已在上面的DOMContentLoaded中初始化，这里不需要重复调用
            
            // 初始化AI数据分析引擎
            window.aiAnalysisEngine = new AIDataAnalysisEngine();
            
            // 初始化实时监控
            window.realTimeMonitoring = new RealTimeMonitoring();
            
            // 初始化预测分析
            window.predictiveAnalysis = new PredictiveAnalysis();
            
            // 初始化数据导出功能
            if (typeof DataExportManager !== 'undefined') {
                window.dataExportManager = new DataExportManager();
                window.exportUI = new ExportUI();
            }
            
            console.log('Dashboard advanced features initialized');
        });
        
        // 数据导出函数
        function exportDashboardData(type) {
            if (window.dataExportManager) {
                let data = [];
                let filename = '';
                
                switch(type) {
                    case 'admission-progress':
                        data = [
                            ['专业', '计划招生', '实际招生', '完成率', '状态'],
                            ['计算机科学', '100', '88', '88%', '预警'],
                            ['机械工程', '80', '60', '75%', '危险'],
                            ['电子工程', '90', '95', '105%', '正常'],
                            ['工商管理', '120', '110', '92%', '正常']
                        ];
                        filename = '招生进度数据';
                        break;
                    case 'student-source-province':
                        data = [
                            ['省份', '学生数量', '占比'],
                            ['北京', '150', '15%'],
                            ['上海', '120', '12%'],
                            ['广东', '200', '20%'],
                            ['江苏', '180', '18%'],
                            ['浙江', '100', '10%']
                        ];
                        filename = '生源省份分布数据';
                        break;
                    default:
                        data = [['数据类型', '数值'], ['总计', '暂无数据']];
                        filename = '数据驾驶舱数据';
                }
                
                window.exportUI.showExportModal(data, filename);
            }
        }

        // 全局函数
        function toggleMonitoringPanel() {
            if (window.realTimeMonitoring) {
                window.realTimeMonitoring.toggleMonitoringPanel();
            }
        }

        function generateIntelligentReport() {
            if (window.aiAnalysisEngine) {
                window.aiAnalysisEngine.generateIntelligentReport();
            }
        }
    </script>
    
    <!-- 引入数据导出功能 -->
    <script src="js/data-export.js"></script>
</body>
</html>